generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  admin
  operator
  supervisor
}

enum Status {
  Online
  Offline
}

enum LineStatus {
  active
  ban
}

enum Sender {
  operator
  contact
}

enum Speed {
  fast
  medium
  slow
}

// Models
model User {
  id            Int             @id @default(autoincrement())
  name          String
  email         String          @unique
  password      String
  role          Role
  segment       Int?
  line          Int?
  status        Status          @default(Offline)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([email])
  @@index([segment])
  @@index([line])
  @@index([role, status])
}

model Segment {
  id            Int             @id @default(autoincrement())
  name          String          @unique
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([name])
}

model Tabulation {
  id            Int             @id @default(autoincrement())
  name          String
  isCPC         Boolean         @default(false)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([name])
}

model Contact {
  id            Int             @id @default(autoincrement())
  name          String
  phone         String
  segment       Int?
  cpf           String?
  contract      String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([phone])
  @@index([cpf])
  @@index([segment])
}

model Campaign {
  id                Int       @id @default(autoincrement())
  name              String
  contactName       String
  contactPhone      String
  contactSegment    Int?
  dateTime          DateTime  @default(now())
  lineReceptor      Int?
  response          Boolean   @default(false)
  speed             Speed
  retryCount        Int       @default(0)
  useTemplate       Boolean   @default(false)
  templateId        Int?
  templateVariables String?   @db.Text
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([contactPhone])
  @@index([contactSegment])
  @@index([lineReceptor])
  @@index([response])
  @@index([dateTime])
  @@index([templateId])
}

model BlockList {
  id            Int       @id @default(autoincrement())
  name          String?
  phone         String?
  cpf           String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([phone])
  @@index([cpf])
}

model LinesStock {
  id              Int           @id @default(autoincrement())
  phone           String        @unique
  lineStatus      LineStatus    @default(active)
  segment         Int?
  linkedTo        Int?
  evolutionName   String
  oficial         Boolean       @default(false)
  token           String?
  businessID      String?
  numberId        String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([phone])
  @@index([lineStatus])
  @@index([segment])
  @@index([linkedTo])
  @@index([evolutionName])
}

model Evolution {
  id              Int           @id @default(autoincrement())
  evolutionName   String        @unique
  evolutionUrl    String
  evolutionKey    String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([evolutionName])
}

model Conversation {
  id              Int         @id @default(autoincrement())
  contactName     String
  contactPhone    String
  segment         Int?
  userName        String?
  userLine        Int?
  message         String      @db.Text
  sender          Sender
  datetime        DateTime    @default(now())
  tabulation      Int?
  messageType     String      @default("text")
  mediaUrl        String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([contactPhone])
  @@index([segment])
  @@index([userLine])
  @@index([tabulation])
  @@index([datetime])
}

model Tag {
  id              Int         @id @default(autoincrement())
  name            String      @unique
  description     String?
  segment         Int?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([name])
  @@index([segment])
}

model ApiLog {
  id              Int         @id @default(autoincrement())
  endpoint        String
  method          String
  requestPayload  String      @db.Text
  responsePayload String      @db.Text
  statusCode      Int
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime    @default(now())

  @@index([endpoint])
  @@index([method])
  @@index([statusCode])
  @@index([createdAt])
}

// Template para mensagens de campanha (vinculado a segmento)
model Template {
  id              Int         @id @default(autoincrement())
  name            String
  language        String      @default("pt_BR")
  category        String      @default("MARKETING")
  segmentId       Int?        // null = global (todos os segmentos)
  lineId          Int?        // Mantido para compatibilidade (pode ser removido futuramente)
  namespace       String?
  status          String      @default("APPROVED")
  headerType      String?
  headerContent   String?     @db.Text
  bodyText        String      @db.Text
  footerText      String?
  buttons         String?     @db.Text
  variables       String?     @db.Text
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([name])
  @@index([segmentId])
  @@index([status])
  @@index([category])
}

// Hist√≥rico de envios de templates
model TemplateMessage {
  id              Int         @id @default(autoincrement())
  templateId      Int
  contactPhone    String
  contactName     String?
  lineId          Int
  status          String      @default("SENT")
  messageId       String?
  variables       String?     @db.Text
  errorMessage    String?
  campaignId      Int?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([templateId])
  @@index([contactPhone])
  @@index([lineId])
  @@index([status])
  @@index([campaignId])
  @@index([createdAt])
}