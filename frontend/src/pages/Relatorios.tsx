import { useState, useEffect, useCallback } from "react";
import { BarChart3, Download, Loader2 } from "lucide-react";
import { MainLayout } from "@/components/layout/MainLayout";
import { GlassCard } from "@/components/ui/glass-card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { toast } from "@/hooks/use-toast";
import { reportsService, segmentsService, Segment } from "@/services/api";

const reportTypes = [
  { value: "op_sintetico", label: "OP Sintético" },
  { value: "kpi", label: "KPI" },
  { value: "hsm", label: "HSM" },
  { value: "status_linha", label: "Status de Linha" },
  { value: "envios", label: "Envios" },
  { value: "indicadores", label: "Indicadores" },
  { value: "tempos", label: "Tempos" },
  { value: "templates", label: "Templates" },
  { value: "completo_csv", label: "Completo CSV" },
  { value: "equipe", label: "Equipe" },
  { value: "dados_transacionados", label: "Dados Transacionados" },
  { value: "detalhado_conversas", label: "Detalhado Conversas" },
  { value: "linhas", label: "Linhas" },
  { value: "resumo_atendimentos", label: "Resumo Atendimentos" },
  { value: "hiper_personalizado", label: "Hiper Personalizado" },
  { value: "consolidado", label: "Consolidado" },
];

export default function Relatorios() {
  const [startDate, setStartDate] = useState("");
  const [endDate, setEndDate] = useState("");
  const [segment, setSegment] = useState("");
  const [segments, setSegments] = useState<Segment[]>([]);
  const [reportType, setReportType] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [reportGenerated, setReportGenerated] = useState(false);
  const [reportBlob, setReportBlob] = useState<Blob | null>(null);

  const loadSegments = useCallback(async () => {
    try {
      const data = await segmentsService.list();
      setSegments(data);
    } catch (error) {
      console.error('Error loading segments:', error);
    }
  }, []);

  useEffect(() => {
    loadSegments();
  }, [loadSegments]);

  const handleGenerate = async () => {
    if (!startDate || !endDate) {
      toast({
        title: "Campos obrigatórios",
        description: "Data inicial e final são obrigatórias",
        variant: "destructive",
      });
      return;
    }

    if (!reportType) {
      toast({
        title: "Tipo de relatório",
        description: "Selecione um tipo de relatório",
        variant: "destructive",
      });
      return;
    }

    setIsLoading(true);
    setReportGenerated(false);
    setReportBlob(null);
    
    try {
      const blob = await reportsService.generate({
        startDate,
        endDate,
        segment: segment && segment !== 'all' ? parseInt(segment) : undefined,
        type: reportType,
      });
      
      setReportBlob(blob);
      setReportGenerated(true);
      toast({
        title: "Relatório gerado",
        description: "O relatório foi gerado com sucesso",
      });
    } catch (error) {
      toast({
        title: "Erro ao gerar relatório",
        description: error instanceof Error ? error.message : "Erro desconhecido",
        variant: "destructive",
      });
    } finally {
      setIsLoading(false);
    }
  };

  const handleExport = () => {
    if (!reportBlob) return;
    
    const url = URL.createObjectURL(reportBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `relatorio_${reportType}_${startDate}_${endDate}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    toast({
      title: "Download iniciado",
      description: "O arquivo está sendo baixado",
    });
  };

  const getSelectedReportLabel = () => {
    return reportTypes.find(r => r.value === reportType)?.label || '';
  };

  return (
    <MainLayout>
      <div className="space-y-6 animate-fade-in">
        {/* Filters */}
        <GlassCard>
          <h2 className="text-xl font-semibold text-foreground mb-6">Relatórios</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div className="space-y-2">
              <Label htmlFor="startDate">Data Inicial *</Label>
              <Input
                id="startDate"
                type="date"
                value={startDate}
                onChange={(e) => setStartDate(e.target.value)}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="endDate">Data Final *</Label>
              <Input
                id="endDate"
                type="date"
                value={endDate}
                onChange={(e) => setEndDate(e.target.value)}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="segment">Segmento</Label>
              <Select value={segment} onValueChange={setSegment}>
                <SelectTrigger>
                  <SelectValue placeholder="Todos" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos</SelectItem>
                  {segments.map((seg) => (
                    <SelectItem key={seg.id} value={seg.id.toString()}>
                      {seg.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div className="flex items-end">
              <Button onClick={handleGenerate} className="w-full" disabled={isLoading}>
                {isLoading ? (
                  <>
                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    Gerando...
                  </>
                ) : (
                  'Gerar Relatório'
                )}
              </Button>
            </div>
          </div>

          <div className="space-y-2">
            <Label>Tipo de Relatório *</Label>
            <div className="flex flex-wrap gap-2">
              {reportTypes.map((type) => (
                <Button
                  key={type.value}
                  variant={reportType === type.value ? "default" : "outline"}
                  size="sm"
                  onClick={() => setReportType(type.value)}
                  className="text-xs"
                >
                  {type.label}
                </Button>
              ))}
            </div>
          </div>
        </GlassCard>

        {/* Results */}
        <GlassCard padding="none">
          {!reportGenerated && !isLoading && (
            <div className="flex flex-col items-center justify-center py-20 text-muted-foreground">
              <BarChart3 className="h-20 w-20 mb-4 opacity-50" />
              <p className="text-lg font-medium">Selecione os filtros e gere um relatório</p>
              <p className="text-sm">Os dados serão exibidos aqui</p>
            </div>
          )}

          {isLoading && (
            <div className="flex flex-col items-center justify-center py-20">
              <Loader2 className="h-16 w-16 animate-spin text-primary mb-4" />
              <p className="text-muted-foreground">Gerando relatório...</p>
            </div>
          )}

          {reportGenerated && reportBlob && (
            <div className="p-6">
              <div className="flex flex-col items-center justify-center py-12">
                <div className="w-16 h-16 rounded-full bg-success/10 flex items-center justify-center mb-4">
                  <BarChart3 className="h-8 w-8 text-success" />
                </div>
                <h3 className="font-semibold text-foreground text-lg mb-2">
                  Relatório Gerado com Sucesso!
                </h3>
                <p className="text-sm text-muted-foreground mb-6 text-center">
                  Relatório: <strong>{getSelectedReportLabel()}</strong><br />
                  Período: {startDate} até {endDate}
                </p>
                <Button onClick={handleExport}>
                  <Download className="mr-2 h-4 w-4" />
                  Baixar CSV
                </Button>
              </div>
            </div>
          )}
        </GlassCard>
      </div>
    </MainLayout>
  );
}
